{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nimport { TransportType, ExtensionMessageTarget, TransportStatus, Origin } from '@airgap/beacon-types';\nimport { Transport, PeerManager, Logger, windowRef } from '@airgap/beacon-core';\nimport { PostMessageClient } from './PostMessageClient';\nconst logger = new Logger('PostMessageTransport');\nlet listeningForExtensions = false;\nlet extensionsPromise;\nlet extensions;\nconst addExtension = extension => {\n  if (!extensions) {\n    extensions = [];\n  }\n  if (!extensions.some(ext => ext.id === extension.id)) {\n    extensions.push(extension);\n    windowRef.postMessage('extensionsUpdated', windowRef.location.origin);\n  }\n};\n/**\r\n * @internalapi\r\n *\r\n *\r\n */\nexport class PostMessageTransport extends Transport {\n  constructor(name, keyPair, storage, storageKey) {\n    super(name, new PostMessageClient(name, keyPair), new PeerManager(storage, storageKey));\n    this.type = TransportType.POST_MESSAGE;\n  }\n  static isAvailable() {\n    return __awaiter(this, void 0, void 0, function* () {\n      return new Promise(resolve => {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const fn = event => {\n          const data = event.data;\n          if (data && data.payload === 'pong') {\n            resolve(true);\n            windowRef.removeEventListener('message', fn);\n          }\n        };\n        windowRef.addEventListener('message', fn);\n        const message = {\n          target: ExtensionMessageTarget.EXTENSION,\n          payload: 'ping'\n        };\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        windowRef.postMessage(message, windowRef.location.origin);\n      });\n    });\n  }\n  static getAvailableExtensions() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (extensionsPromise) {\n        return extensionsPromise;\n      }\n      if (extensions) {\n        return extensions;\n      }\n      extensions = [];\n      extensionsPromise = new Promise(resolve => {\n        PostMessageTransport.listenForExtensions();\n        setTimeout(() => {\n          resolve(extensions !== null && extensions !== void 0 ? extensions : []);\n        }, 1000);\n      }).finally(() => {\n        extensionsPromise = undefined;\n      });\n      return extensionsPromise;\n    });\n  }\n  static listenForExtensions() {\n    if (listeningForExtensions) {\n      return;\n    }\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const fn = event => {\n      if (event.source !== windowRef || event.origin !== windowRef.location.origin) {\n        // TODO: Add to error handler: console.debug('[Beacon]: Event received from untrusted origin')\n        return;\n      }\n      const data = event.data;\n      const sender = data.sender;\n      if (data && data.payload === 'pong' && sender) {\n        logger.log('getAvailableExtensions', `extension \"${sender.name}\" is available`, sender);\n        addExtension(sender);\n      }\n    };\n    windowRef.addEventListener('message', fn);\n    const message = {\n      target: ExtensionMessageTarget.EXTENSION,\n      payload: 'ping'\n    };\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    windowRef.postMessage(message, windowRef.location.origin);\n    listeningForExtensions = true;\n  }\n  connect() {\n    const _super = Object.create(null, {\n      connect: {\n        get: () => super.connect\n      }\n    });\n    return __awaiter(this, void 0, void 0, function* () {\n      logger.log('connect');\n      if (this._isConnected !== TransportStatus.NOT_CONNECTED) {\n        return;\n      }\n      this._isConnected = TransportStatus.CONNECTING;\n      const knownPeers = yield this.getPeers();\n      if (knownPeers.length > 0) {\n        logger.log('connect', `connecting to ${knownPeers.length} peers`);\n        const connectionPromises = knownPeers.map(peer => __awaiter(this, void 0, void 0, function* () {\n          return this.listen(peer.publicKey);\n        }));\n        Promise.all(connectionPromises).catch(error => logger.error('connect', error));\n      }\n      yield this.startOpenChannelListener();\n      yield _super.connect.call(this);\n    });\n  }\n  startOpenChannelListener() {\n    return __awaiter(this, void 0, void 0, function* () {\n      //\n    });\n  }\n  getPairingRequestInfo() {\n    return __awaiter(this, void 0, void 0, function* () {\n      return this.client.getPairingRequestInfo();\n    });\n  }\n  listen(publicKey) {\n    return __awaiter(this, void 0, void 0, function* () {\n      logger.log('listen', publicKey);\n      yield this.client.listenForEncryptedMessage(publicKey, (message, context) => {\n        const connectionContext = {\n          origin: Origin.EXTENSION,\n          id: context.id\n        };\n        this.notifyListeners(message, connectionContext).catch(error => {\n          throw error;\n        });\n      }).catch(error => {\n        throw error;\n      });\n    });\n  }\n}","map":{"version":3,"names":["TransportType","ExtensionMessageTarget","TransportStatus","Origin","Transport","PeerManager","Logger","windowRef","PostMessageClient","logger","listeningForExtensions","extensionsPromise","extensions","addExtension","extension","some","ext","id","push","postMessage","location","origin","PostMessageTransport","constructor","name","keyPair","storage","storageKey","type","POST_MESSAGE","isAvailable","Promise","resolve","fn","event","data","payload","removeEventListener","addEventListener","message","target","EXTENSION","getAvailableExtensions","listenForExtensions","setTimeout","finally","undefined","source","sender","log","connect","_isConnected","NOT_CONNECTED","CONNECTING","knownPeers","getPeers","length","connectionPromises","map","peer","__awaiter","listen","publicKey","all","catch","error","startOpenChannelListener","_super","call","getPairingRequestInfo","client","listenForEncryptedMessage","context","connectionContext","notifyListeners"],"sources":["../../src/PostMessageTransport.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module"}